# @spinque/query-api

[![npm version](https://img.shields.io/npm/v/@spinque/query-api.svg?style=flat-square)](https://www.npmjs.org/package/@spinque/query-api)
![Build status](https://github.com/axios/axios/actions/workflows/ci.yml/badge.svg)
[![install size](https://packagephobia.now.sh/badge?p=@spinque/query-api)](https://packagephobia.now.sh/result?p=@spinque/query-api)
[![Known Vulnerabilities](https://snyk.io/test/npm/@spinque/query-api/badge.svg)](https://snyk.io/test/npm/@spinque/query-api)

Library to use the Spinque Query API in your JavaScript/TypeScript project.

Also check out the [documentation of the Spinque Query API](https://docs.spinque.com/3.0/using-apis/basic.html).

## Installing

Using npm:

```bash
$ npm install @spinque/query-api
```

## Usage

### Defining queries

Defining a single query:

```typescript
import { Query } from '@spinque/query-api';

const query: Query = {
  endpoint: 'movie_search',
  parameters: { terms: 'call me' }
};
```

### Fetching results

Fetching results for a single query using an instance of the Api class:

```typescript
import { Api, Query } from '@spinque/query-api';

const api = new Api({
  workspace: 'my-workspace',
  config: 'default',
  api: 'movies'
});

const query: Query = {
  endpoint: 'movie_search',
  parameters: { terms: 'call me' }
};

try {
  const response = await api.fetch(query, { count: 10 });
} catch (error: any) {
  console.error(error);
}
```

### Fetching using custom HTTP-library

Getting the URL for a request to fetch it using your own HTTP-library of preference:

```typescript
import { urlFromQueries } from '@spinque/query-api/utils';

const apiConfig = {
  workspace: 'my-workspace',
  config: 'default',
  api: 'movies'
};

const query: Query = {
  endpoint: 'movie_search',
  parameters: { terms: 'call me' }
};

const url = urlFromQueries(apiConfig, query, { count: 10, offset: 0 });
```

### Authentication

Some Spinque APIs require authentication using OAuth 2.0. The Client Credentials flow (for server applications) and PKCE flow (for browser applications) are provided by `@spinque/query-api`:

#### Client Credentials flow (for server applications)

```typescript
import { Api } from '@spinque/query-api';

const api = new Api({
  workspace: 'my-workspace',
  config: 'default',
  api: 'movies',
  authentication: {
    type: 'client-credentials',
    clientId: 'abcdefghijklmnopqrstuvwxyz',
    clientSecret: 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',
  }
});

const query: Query = {
  endpoint: 'movie_search',
  parameters: { terms: 'call me' }
};

const response = await api.fetch(queries);
```

Note: the Client ID and Client Secret can be generated by creating a new System-to-System account in the Settings > Team Members section of Spinque Desk.

#### PKCE flow (for browser applications)

```typescript
import { Api } from '@spinque/query-api';

const api = new Api({
  workspace: 'my-workspace',
  config: 'default',
  api: 'movies',
  authentication: {
    type: 'pkce',
    clientId: 'abcdefghijklmnopqrstuvwxyz',
    callback: 'https://my-domain.com/callback'
  }
});

const query = {
  endpoint: 'movie',
  parameters: { id: 'https://imdb.com/data/movie/tt0209144' }
};

const response = await api.fetch(queries, { count: 10, offset: 0 });
```

Note: the Client ID and Callback URL cannot yet be configured from Spinque Desk. Ask your system administrator to help you out.


### Faceted search

Faceted search is a common use-case for application built on Spinque.
This library provides a FacetedSearch to ease the interaction between queries in a faceted search setup.

The following example shows how a search endpoint 'movie_search' can be used in combination with a facet endpoint 'genre'.

```typescript
import { Api, FacetedSearch } from '@spinque/query-api';

const query: Query = {
  endpoint: 'movie_search',
  parameters: { query: 'call me' }
};

const fs = new FacetedSearch(query).withFacet('genre', 'multiple');

// Get results and facet options
let results = await api.fetch(fs.getResultsQueries());
let options = await api.fetch(fs.getFacetOptions());

// Set the search query parameter (e.g. after the user has typed something)
fs.setParameter('query', 'the grand');

// Get updated results and options
results = await api.fetch(fs.getResultsQueries());
options = await api.fetch(fs.getFacetOptions());

// Select a facet option
fs.setFacetSelection('genre', 'https://imdb.com/schema/Drama');

// Get results again
results = await api.fetch(fs.getResultsQueries());
```

Optionally, you can provide a Query for when the search parameters are empty.

```typescript
...

const listQuery: Query = { endpoint: 'movies' };

const fs = new FacetedSearch(query, listQuery);
```

### Vanilla JavaScript

This library can also be used without using TypeScript:

```javascript
const sqa = require("@spinque/query-api");

const api = new sqa.Api({
  workspace: 'my-workspace',
  api: 'movies'
});

const query = {
  endpoint: 'search',
  parameters: { term: 'utrecht' }
};

try {
  const results = await api.fetch(query);
  console.log(results);
} catch (error) {
  console.log(error);
}
```